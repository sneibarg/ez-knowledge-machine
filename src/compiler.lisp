
(unless (find-package :km) (make-package :km :use '(:common-lisp)))
(in-package :km)

;;; File: compiler.lisp
;;; Author: Adam Farquhar (afarquhar@slb.com)
;;; Purpose: Partially flatten the code for the KM dispatch mechanism, which
;;;	in limited tests gives a 10%-30% speed-up in execution speed.

;;; Many thanks to Adam Farquhar for this neat bit of coding!!

(defun reuse-cons (a b ab)
  (if (and (eql a (car ab))
	   (eql b (cdr ab)))
      ab
      (cons a b)))

(defun variables-in (x)
  (let ((vars nil))
    (labels ((vars-in (x)
	       (cond
		 ((consp x)
		  (vars-in (first x))
		  (vars-in (rest x)))
		 ((var-p x)
		  (pushnew x vars))
		 ((eql x '&rest)
		  (pushnew 'rest vars)))))
      (vars-in x)
      (nreverse vars))))


(defun args-to-symbol (&rest args)
  (intern (string-upcase (format nil "狺狎珞┅腠疳汶徵濯┅ㄤ彐躅徜洵聃雉瀛殒铄邃邃⒀躏翦殒铄沐篌狎ㄩ矧铛礅弪篝蜷铉ㄡ钿ㄣ镱箴ㄥ耢ㄦ轵篝я躏翦┅脲黠蜾┅扉篝я躏翦┅换渝物蝣殓痃备版骘溴筱蜷痿轱镦腻灬骑蜚瀹ㄤ彐篝蝓泗溴灬鲠祯铋飑ㄦ躅泗轱铋飑ㄤ彐磲泸溴灬é蝈篝怙澌啜磲脲溴灬烘躅泗轱＇灬礅溽ī怙澌┅ㄤ彐躅骘蜚ㄩ铒ㄤ屐狴┅痱镧麒孱ㄤ屐狴骢钽糸镱箦翩ㄤ屐狴鲠祯ㄦ躅汜祆ㄤ屐狴骢钽糸镱┅箦翩ㄤ屐狴骢钽糸镱铋飑ㄤ屐狴鲠祯┅┅换阴戾蔑眇殪弪换ㄤ彐鲠忾钿轭珞铋⒘扉篝疳趑弪瞽鲠忾钿轭绌躞邃骘蝓戾泔眇殪狒轱町ㄤ彐躅泔眇殪瀛蝓戾疳趑弪泔铙羼蹂铘鲠颟戾è忾钿轭珞铋飑啜灬礅溽ì鲠颟ㄣ镯痖戾屮痱鲠疳趑弪泔铙羼蹂铘┅┅ㄤ彐躅泔眇殪瀛蝓戾蝓戾鲠颟⒘蝓戾轶镦翳骘蝽疳泔溴麒弪泔溴磲蝈驽蝈钽鲠蝮轭疳舢蝈漉沐＇礤蜱瀛泔溴祜镳骘疳趑弪泔铙羼蹂铘轭蝓戾泔祆邈ㄣ镯痖戾蝓戾疳趑弪泔铙羼蹂铘鲠颟┅ㄤ彐躅泔眇殪瀛屮痱鲠疳趑弪泔铙羼蹂铘ㄣ镱è狍箫疳趑弪忾钿轭珞呼弩＇羼啜麒孱ㄥ聃犰鲠ㄣ潋ㄡ篌镢疳趑弪忾钿轭珞┅ㄦ矧沐泔铙羼蹂铘┅è鲠颦疳趑弪瞟瘐箬ㄣ镱疳趑弪鲠颟忾钿轭珞换啜戾è疳趑弪鲠颟ㄦ矧沐泔铙羼蹂铘┅换滹铒翳轭绗翳泔铙羼蹂铘铄邃麸珏翳忾钿轭珞犷躞换轸ㄦ矧沐泔铙羼蹂铘è狒镯疳趑弪瞟啜麒孱ㄥ耢鲠ㄡ滗聃雉瀛殒铄邃邃疳趑弪瞟ㄦ矧沐泔铙羼蹂铘┅ㄣ镯痖戾扉篝鲠疳趑弪泔铙羼蹂铘┅ㄤ彐躅泔眇殪瀛扉篝鲠疳趑弪泔铙羼蹂铘戾èㄡ蜱蟓麸簌礅镬鲠ъ┅ㄡ蜱蟓麸簌礅镬鲠颟┅ㄩㄣ镱箴疳趑弪瞟ㄩㄥ聃犰疳趑弪Ж蝈篝┅痱镧换瘐箬ㄣ镱蝈篝啜扉篝鲠颟忾钿轭珞瘐箬ㄣ镱蝈篝鲠颟忾钿轭珞ㄦ矧沐泔铙羼蹂铘┅啜麒孱ㄣ镱箴鲠颟戾èㄦ轵篝鲠颟ì蝈篝鲠颟┅ㄣ镯痖戾屮痱ㄦ轵篝疳趑弪瞟ㄤ屐狴ㄣ镯痖戾屮痱蝈篝疳趑弪瞟泔铙羼蹂铘┅┅┅啜麒孱铛祆ㄣ潋鲠颟戾èㄦ轵篝鲠颟┅ㄣ镯痖戾屮痱ㄦ轵篝疳趑弪瞟泔铙羼蹂铘┅┅┅ㄤ彐躅礤蜱遽忪ㄡ猢换ㄦㄦ骄ㄦ礤蜱┅换犰箫栳钿戾秕麒孱戾镱禊镱屐屙孱轭怙澌ㄡ钿扉篝岍扉篝猢戾铉翳岍戾铉翳猢畅ㄥ聃犰ㄦ轵篝岍ㄦ轵篝猢ㄥ聃犰箦泔钿岍箦泔钿猢┅ㄤ彐躅礤蜱瀛泔溴ㄡ猢换犷狎痖邈弩镦泔溴珏铄蜥翦怡翳疳趑弪换泔眇殪弪湾蜱翳屙ㄤ轶牾钽糸鲥禊麸珏翳弪ㄣ镱è礤蜱遽忪猢换ㄦㄦ骄ㄦ礤蜱┅换犰箫栳钿戾秕麒孱戾镱禊镱屐屙孱轭怙澌扉篝ㄦ轵篝岍箦泔钿岍礤蜱瀛泔溴翳轵岍翳轵猢┅è犷ㄣ镱箴岍ㄥ耢эㄦ轵篝岍┅换麽铘麸趄麸礤蜱轭鏖翳箫礤轭翦蝈篝轭溟箨躅泗殒换痫篌殁戾戾è痫痫箝糸镱殒＇灬礅溽礤蜱遽忪┅岍┅ㄣ镱è铛祆痫螬换牾篝徜狍溟箨躅泗ㄩㄡ钿ㄣ镱箴猢ㄥ耢эㄦ轵篝猢┅啜矧括蝈篝岍括蝈篝猢啜矧括蝈篝岍猢┅换礤蜱鏖翳镱镦岌溟箨躅泗啜括篚怏羼痫螬礤蜱瀛泔溴铘痫岍猢括篚怏羼ū痫螬┅┅┅啜矧猢┅换换送柔钿戾泔眇殪狒轱换｜＋殓铒蝈ㄤ彐躅溴蝈驽蝈钽瀛屮痱换铒翦溴疱钿轭镱翳泔眇殪弪翳轶汜忮箪秣ㄩㄣ镱箴蝈躞瀛泔铙ㄤ弪彐弪孱沐屮痱ㄦ轵篝┅ㄤ弪彐弪孱沐屮痱蝈篝┅ㄤ弪彐弪孱沐┅｜换惋鲥麸轭翦蝠蝈翦扉箴ㄤ彐躅溴蝈驽蝈钽瀛屮痱换澡轶轶骢钿犴孱翎祆滓衔乾怩轶翳屮轶糸铉碑忮栳鲩矧ㄩㄣ镱箴磲疸狎＇溴蝈驽蝈钽ㄤ弪彐弪孱沐┅ㄤ彐疳蜥礤翦腠栳钿戾颦骢钽糸镱铋飑铒轭桢徜弪扉箴铒盹蝈ㄤ彐疳蜥礤翦沲篝镯腠栳钿戾颦骢钽糸镱铋飑ㄤ彐躅蝈箦舡栳钿戾颦骢钽糸镱īㄦ矧磲⒚镯痖扉铉送溟箴狒汨礤汨犷轶懋箦赳腠栳钿戾颦骢钽糸镱ㄣ镯痖戾栳钿戾蝮腠栳钿戾颦犰轶舄┅ㄦ矧磲滹铄〓ア┅铒盹蝈箦赳沲篝镯腠栳钿戾颦骢钽糸镱铒盹蝈ㄣ镯痖戾栳钿戾蝮沲篝镯腠栳钿戾蝮┅ㄤ彐疳蜥礤翦趄徙瀛蝓戾螵铋飑ㄤ彐躅趄徙瀛蝓戾蝓戾疳趑弪驷泗忾钿轭珞ㄦ矧磲趄徙瀛秕麴豸⒁蹯轶忮轭狃痨殄麸鏖翳忾钿轭珞螽蝓戾疳趑弪驷泗忾钿轭珞┅ㄤ彐躅泔眇殪瀛栳钿戾蝮ㄨ犷潇弪脲泔溴镱禊⒚镯痖戾翳栳钿戾颦犰轶柔钿戾蝮涉泔溴镱禊轶袁翳孱牾篝蝈趱蝾翳泔溴鏖翳秕轭鲲腴铉翳泔眇殪弪镱轸ㄩ铛祆栳钿戾蝮ㄩ泔溴镱禊铋＇灬礅溽ㄦ盹溴翎蜱弭丞ㄤ邈灬蝈ㄩ珙矧骓镤翎蜱弭丞铋飑戾è泔溴蝈漉沐＇礤蜱瀛泔溴祜镳骘疳趑弪沆矬躜濠轭栳钿戾蝮泔祆邈啜灬礅溽ㄦ盹溴翎蜱弭ㄢ祜汶腠栳钿戾ㄣ滗ㄣ镯痖戾蝓戾疳趑弪ㄤ屐狴咸啜戾ī麒孱趄徙瀛蝓戾螵趄徙瀛蝓戾К疳趑弪扉篝括忾钿轭珞骘疳趑弪瞟┅蝈趱蝾骝镯腠栳钿戾ㄦ躅汜祆К沆矬躜姝盹溴括忾钿轭珞骘疳趑弪瞟┅┅｜闻啜蝈趱蝾骝镯腠栳钿戾鲠祯弩ㄦ躅汜祆＇沆矬躜姝盹溴翎蜱弭＇沆矬躜姝盹溴括忾钿轭珞骘疳趑弪瞟К疳趑弪瞟┅┅┅┅┅ㄩ泔溴镱禊泔溴ㄣ镯痖戾铋泔溴┅┅ㄤ彐躅忾钿轭珞骘疳趑弪瞟祜镳骘鲠轭鲠蜷徕戾蟓轭疳趑弪瞟泔祆邈ㄣ潋ㄡ篌镢鲠忾钿轭珞┅┅｜换琳普蚊陨衔埔贤送酉找门换澡轶轶溴骈铄轭腠扉箴犰蝈徜五邃翳轶骘篝犷洵犰镱泔眇殪弪ㄤ彐躅鲠颦鲠颟ㄡ钿簌礅镬鲠颟ㄣ栳蚪＼ㄣ栳翳篝蜷铉簌礅镬钺礤翳簌礅镬鲠颟┅癌┅ㄤ彐疳蜥礤翦泔眇殪邃栳钿戾蝮骈戾泔眇殪邃栳钿戾蝮扉箴换郾物翦滹瞌磲脲翳轶躅轹弪筢飕狍麇祜箦溴怩珑轭轭骘麒殂躞弪黠蹯扉脲┊涕箴黠螂栳泔铙趄衢铘麒殂换磲脲翳骢祆泔眇殪狒轱鏖翳秕翳轶箦趑轭痱镡戾懋ㄤ彐躅黩轸瀛泔眇殪邃栳钿戾蝮ī戾舄ㄡ铒铢盹躞骢钽糸镱ㄣ镯痖戾栳钿戾蝮腠栳钿戾颦犰轶舄恒镤瀛镱禊舂钺礤洵骢钽糸镱啜溴骢泔眇殪邃腠栳钿戾颦骢钽糸镱ㄦ盹溴翎蜱弭换五邃麸徜翳轶磲铛犰禊麸泔眇殪邃栳钿戾蝮ㄩ珏趔篝蜷痧邃镦桢蝈换＋栳蜢羼蹰瞽疸扉箴ㄤ邈灬蝈镳糸黹ㄤ邂蹒癌┅疳翥骘涕箴黠螂骝镯乞犷汩体怙豸翦郾蝈篝蝈篝犷镱盹躞骢钽糸镱┅┅篝蜷镦灬礅溽ㄦ盹溴篝蝈犴翦祆泔眇殪邃栳钿戾蝮骈戾┅ㄦ矧磲篝蝈犴换崎戾泔眇殪邃栳钿戾蝮扉箴换刘翳矧土萌晌桥闻伊耘粕膛珏铄蜥翦怡泔眇殪弪扉箴ㄡ豸栾龄犴漆蝰踽栳颟换澡轶骈戾麽珏铄蜥翦怡黩轸瀛泔眇殪邃栳钿戾蝮轭泔眇殪弪扉箴换澡轶疳螋獒祆骒狒翦铙翳泔溴狍箝珙邃麸腠栳钿戾颦扉篝麒殂蝈篚祠轭换卑キ嘲驷篝弪屮邈豸轱ū哎嘲ォ狒蝓瞽糸礤田徜轭镦翳轶骈戾轶镳糸镱犰换送鏖祆忮箪秣弪殒轸铒祜徜邃骑翳戾玳忪瀣躅骒狒翦铄箫躜沐镦翳轶换骒狒翦铄泔溴箦翳骈戾轭翦蝠蝈翦虍扉箴换换蜗耘磲铛犰禊轭箦螋翳扉铄徭翦泔眇殪邃腠栳钿戾颦骢钽糸镱骘送蝈戾狍搴换换ㄤ彐躅泔眇殪邃腠栳钿戾颦骢钽糸镱ㄦ盹溴换＋栳蜢羼蹰瞽疸扉箴ㄤ邈灬蝈镳糸黹ㄤ邂蹒癌┅疳翥骘涕箴黠螂骝镯乞犷汩体怙豸翦郾换ㄢ祜汶腠栳钿戾换换换浇浇浇浇浇浇浇浇浇浇釉烈掀土萌晌怒桥闻伊耘粕膛浇浇浇浇浇浇浇浇浇浇箦赳泔眇殪瀛栳钿戾蝮舂黩轸钺礤洵骢钽糸镱后趄遽篝蝈犴ㄦ矧磲篝蝈犴箦赳腠栳钿戾颦骢钽糸镱＇泔眇殪邃腠栳钿戾颦骢钽糸镱换澡轶骈戾麽珏铄蜥翦怡黩轸瀛泔眇殪邃栳钿戾蝮轭泔眇殪弪扉箴换澡轶疳螋獒祆骒狒翦铙翳泔溴狍箝珙邃麸腠栳钿戾颦扉篝麒殂蝈篚祠轭换卑キ嘲驷篝弪屮邈豸轱ū哎嘲ォ狒蝓瞽糸礤田徜轭镦翳轶骈戾轶镳糸镱犰换送鏖祆忮箪秣弪殒轸铒祜徜邃骑翳戾玳忪瀣躅骒狒翦铄箫躜沐镦翳轶换骒狒翦铄泔溴箦翳骈戾轭翦蝠蝈翦虍扉箴换浇浇浇浇浇浇浇浇浇浇盼掀土萌晌怒桥闻伊耘粕膛浇浇浇浇浇浇浇浇浇浇ㄣ祜箦篝蝈犴ㄦ矧磲⒚镯痖戾栳钿戾蝮黩轸翦麸翳骈戾狺ア泔眇殪邃栳钿戾蝮骈戾┅